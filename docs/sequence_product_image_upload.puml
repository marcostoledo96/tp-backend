@startuml
title Creación de Producto con Imagen (POST /api/productos)
actor Admin as A
participant "Frontend React\n(Form Crear Producto)" as FE
participant "AuthContext" as AUTH
participant "Express Router /productos" as R
participant "Middleware verificarAutenticacion" as M1
participant "Middleware verificarPermiso" as M2
participant "ProductoController.crearProducto" as PC
participant "Módulo subida (multer)" as UP
participant "ProductoModel" as PM
participant "DB" as DB

A -> FE: Abre formulario nuevo producto
A -> FE: Completa campos (nombre, precio, stock, ...)
A -> FE: Selecciona archivo imagen
FE -> FE: Construye FormData (incluye file)
FE -> AUTH: Obtener token
AUTH --> FE: token
FE -> R: POST /api/productos (multipart/form-data) Authorization: Bearer
R -> M1: verificarAutenticacion
M1 -> M2: verificarPermiso('gestionar_productos')
M2 -> DB: SELECT permisos rol
DB --> M2: Lista permisos
alt Tiene permiso
  M2 --> R: OK
  R -> UP: Procesar archivo (validar mimetype, tamaño)
  UP -> FS: Guardar /public/uploads/productos/imagen_xyz.jpg
  FS --> UP: Ruta final
  R -> PC: crearProducto(datos + rutaImagen)
  PC -> PM: crearProducto()
  PM -> DB: INSERT INTO productos (..., imagen_url, activo=1)
  DB --> PM: lastInsertRowid
  PM --> PC: resultado
  PC --> R: 201 { id, nombre, imagen_url }
  R --> FE: Éxito JSON
  FE -> A: Mostrar confirmación / redirigir
else Sin permiso
  M2 --> R: 403 { error:'Permiso insuficiente' }
  R --> FE: Error
  FE -> A: Mostrar acceso denegado
end
@enduml