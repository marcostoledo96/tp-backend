@startuml
title Actualización de Perfil Propio (/api/usuarios/profile)
actor Usuario as U
participant "Frontend React\n(Profile.tsx)" as FE
participant "AuthContext" as AUTH
participant "Express Router /usuarios" as R
participant "Middleware verificarAutenticacion" as M1
participant "UsuarioController.actualizarPerfil" as UC
participant "DB" as DB

U -> FE: Abre /profile
FE -> AUTH: Obtener user (name, phone)
AUTH --> FE: Datos usuario
FE -> FE: Prellena formulario

U -> FE: Modifica nombre / teléfono / password
U -> FE: Click "Guardar cambios"
FE -> R: PUT /api/usuarios/profile (Authorization: token)\nBody { nombre_completo?, telefono?, password? }
R -> M1: verificarAutenticacion
M1 -> M1: Decodificar JWT
alt Token válido
  M1 --> R: req.user.userId
  R -> UC: actualizarPerfil(userId, campos)
  UC -> DB: SELECT * FROM usuarios WHERE id = userId
  DB --> UC: Datos actuales
  alt Hay campos a actualizar
    UC -> UC: Construir SET dinámico
    alt Incluye password
      UC -> UC: bcrypt.hash(password)
    end
    UC -> DB: UPDATE usuarios SET ... WHERE id = userId
    DB --> UC: OK
    UC --> R: 200 { mensaje: 'Perfil actualizado' }
    R --> FE: Éxito
    FE -> AUTH: setUser({...})
    FE -> U: Toast éxito
  else Sin cambios
    UC --> R: 400 { error: 'No hay datos para actualizar' }
    R --> FE: Error
    FE -> U: Mostrar mensaje
  end
else Token inválido
  M1 --> R: 401 { error: 'No autenticado' }
  R --> FE: 401
  FE -> U: Redirigir login
end
@enduml