@startuml
title Checkout Compra - Pago por Transferencia (con comprobante)
actor Usuario as U
participant "Frontend React\n(Checkout)" as FE
participant "AuthContext" as AUTH
participant "Express Router /compras" as R
participant "CompraController" as CC
participant "CompraModel" as CM
participant "Almacenamiento uploads/" as FS
participant "DB" as DB

U -> FE: Selecciona método = transferencia
U -> FE: Adjunta archivo comprobante (imagen/pdf)
FE -> AUTH: Obtener user {name, phone}
AUTH --> FE: Datos usuario
FE -> FE: Autocompleta nombre y teléfono
U -> FE: Confirma compra
FE -> R: POST /api/compras (multipart/form-data)\n{ comprador_nombre, comprador_telefono, mesa, metodo=transferencia, comprobante }
R -> CC: crearCompra(formData)
CC -> CC: Validar obligatoriedad comprobante
CC -> FS: Guardar archivo en /public/uploads/comprobantes
FS --> CC: Ruta final archivo
CC -> CM: insertarCompra(datos + ruta_comprobante)
CM -> DB: INSERT INTO compras (..., comprobante_path, metodo='transferencia')
DB --> CM: rowid compra
alt Hay detalles del carrito
  CC -> CM: insertarDetalle(compra_id, producto_id, cantidad, precio_unit)
  CM -> DB: INSERT detalles_compra
end
CC -> CM: marcarCompraListaSiCorresponde(compra_id)
CM -> DB: UPDATE compras SET listo=1 (si aplica)
CC --> R: 201 { compra_id, estado, comprobante_path }
R --> FE: Respuesta OK
FE -> FE: Limpiar carrito
FE -> U: Navegar a /order-confirmation
@enduml