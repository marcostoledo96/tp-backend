@startuml
title Checkout Compra - Pago en Efectivo
actor Usuario as U
participant "Frontend React\n(Checkout)" as FE
participant "AuthContext" as AUTH
participant "Express Router /compras" as R
participant "CompraController" as CC
participant "CompraModel" as CM
participant "DB" as DB

U -> FE: Completa formulario (nombre, teléfono, mesa, método=efectivo)
FE -> AUTH: Obtener user {name, phone}
AUTH --> FE: Datos usuario
FE -> FE: Autocompleta campos
U -> FE: Confirma compra
FE -> R: POST /api/compras (Authorization: token)\nBody: FormData (sin comprobante)
R -> CC: crearCompra(datos)
CC -> CC: Validar campos obligatorios
CC -> CM: insertarCompra(datos básicos)
CM -> DB: INSERT INTO compras ...
DB --> CM: rowid compra
alt Hay detalles carrito
  FE -> R: (en la misma petición) detalles productos
  CC -> CM: insertarDetalle(compra_id, producto_id, cantidad, precio_unit)
  CM -> DB: INSERT detalles_compra
end
CC -> CM: marcarCompraListaSiCorresponde(compra_id)
CM -> DB: UPDATE compras SET listo = 1 (si aplica)
CC --> R: 201 { compra_id, estado }
R --> FE: Respuesta OK
FE -> FE: Limpiar carrito local
FE -> U: Navegar a /order-confirmation
@enduml